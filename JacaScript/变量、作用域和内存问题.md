# 变量、作用域和内存问题

## 变量：

### 1、基本类型

指简单的数据段，源自以下5种：

> 基本类型值在内存中占据固定大小的空间，因此被保存在栈内存中

- Undefined
- Null
- Boolean
- Number
- String

提示：不允许给基本类型添加属性（尽管这样做不会导致任何错误）：

```javascript
var name = ‘Bert’;
name.age = 27;
alert(name.age); //undefined
```

<span>
  <img style="height: 250px" src="./img/基本类型的赋值.jpeg" alt="基本类型赋值">
</span>

说明：只能给引用类型值动态地添加属性，以便将来使用。

```javascript
var num1 = 5; var num2 = num1;
```

num1中保存的值是5。当使用num1的值来初始化num2是，num2中也保存了值5.但num2中的5与num1中的5是完全独立的，该值知识num1中5的一个副本。

> 基本类型的赋值是拷贝一份副本给另一个变量，两个变量参与任何操作不会相互影响。

### 2、引用类型

指那些可能由多个值构成的对象

> 注意：引用类型的值是保存在内存中的对象。与其他语言不同，JavaScript不允许直接访问内存中的位置，也就是说不能直接操作对象的内存空间。在操作对象时，实际上是在操作对象的引用（内存地址）而不是实际的对象。为此，引用类型的值是按引用访问的。

#### 引用类型的赋值：

引用变量间的复制操作，也是将存储在变量对象中的值复制一份放到新变量中，不同的是这类值是指针（内存中的一段地址），这个指针指向存储在推中的一个对象。

复制操作结束后，两个变量实际上将引用同一个对象。因此，改变其中一个变量，就会影响另一个变量。

```javascript
var obj1 = new Object();
var obk2 = obj1;
obj1.name = "Bert";
alert(obj2.name); // bert
```

![基本类型赋值](./img/yinyongleixingdefuzhi.jpg)

### 3、参数传递

ECMAScript中所有的函数的参数都是按值传递的。也就是说，把函数外部的值复制给函数内部的参数，就和把值从一个变量复制到另一个变量一样。

> 在向参数传递基本类型的值时，被传递的值会被复制给一个局部变量（即命名参数，或者用ECMAScript的概念来说，就是arguments对象中的一个元素）。

### 4、类型检测

#### typeof

`typeof` 操作符是确定一个变量是字符串、数值、布尔值、还是undefined的最佳工具。

> 如果变量的值是一个对象或null，则typeof操作符会像下面例子中所示的那样返回 object

```javascript
var a = "Bert";
var b = true;
var c = 22;
var d;
var e = null;
var f = new Object();

alert(typeof a); // string
alert(typeof b); // boolean
alert(typeof c); // number
alert(typeof d); // undefined
alert(typeof e); // object
alert(typeof f); // object
```

#### instanceof

检测引用类型使用 `instanceof` 操作符

> 如果变量是引用类型（根据它的原型链来识别） `instanceof` 返回 true 或 false

```javascript
alert(person instanceof Object); // 变量 person 是 Object 类型吗？
alert(colors instanceof Array); // 变量 colors 是 Array 类型吗？
alert(pattern instanceof RegExp); // 变量 pattern 是 RegExp 类型吗？
```

> 注意，匹配的对象首字母大写

### 5、执行环境及作用域

> 执行环境是JavaScript中最为重要的一个概念。（执行环境有全局执行环境和函数执行环境之分）

执行环境定义了变量或函数有权访问的其他数据，决定他们各自的行为。

每个执行环境都有一个与之关联的 `变量对象`，环境中定义的所有变量和函数都保存在这个对象中。

虽然我们编写的代码无法访问这个对象，单解析器在处理数据时会在后台使用它。

> 在 Web 浏览器中，全局执行环境被认为是window对象（全局执行环境值到应用程序退出，例如关闭网页或浏览器时才会被销毁）

#### 函数（执行环境）

每个函数第一页租户的 `执行环境`。 当执行流进入一个函数时（执行一个函数），函数的环境就会被推入一个环境栈中。

在函数执行之后，栈将其环境弹出，把控制权返回给之前的执行环境。（假设之前的执行环境仍是一个函数，那么就会循环释放直至根环境）

#### 作用域链

当代码在一个执行环境中执行时，会创建变量对象的一个 `作用域链`。作用域链的用途是保证对执行环境有权访问的所有变量和函数的有序访问。

> 那 this 和 `作用域链` 的关系如何解释？

作用域链的前端始终都是单签执行的代码所在环境的变量对象。

如果这个环境是函数，则将其 `活动对象` 作为变量对象。活动对象在最开始时只包含一个变量，即 arguments 对象（这个对象在全局环境中是不存在的）。

> 简单来说作用域链是一层一层从根至底的树形结构，底层可以访问顶层的数据，而顶层无法访问底层的数据（劳资我出生的时候怎么会知道自己将来会生几个儿子！！ 放过来说做儿子的肯定知道自己的劳资是谁）

#### 延长作用域链

- try - catch 语句的 catch 块
- with语句

这两个语句都会在作用域链的前端添加一个变量对象。

with：会将制定的对象添加到作用域链中。

catch：会创建一个新的变量对象，其中包含的是被抛出的错误对象声明。

#### 没有块级作用域

JavaScript 没有块级作用。

- 在if、for语句中声明的变量会被保存在当前执行环境中，在其执行结束时不会被销毁。
- 不使用 var 声明的变量默认绑定到全局环境中。

### 6、垃圾回收、性能问题

在有的浏览器中可以出发垃圾收集过程（不建议使用）

- 用 window.CollectGarbage()方法会立即执行垃圾收集。
- 在Opera7及更高版本中，调用 window.opera.collect()也会启动垃圾收集例程。

> 有那么一点意思..

有垃圾回收机制的语言编写程序一般不必操心内存管理问题。

出于安全考虑，Web浏览器可用内存数量通常要少于桌面应用。因此，确保占用最少的内容可以让页面获得更好的性能。

优化内存占用的最佳方式，就是为执行中的代码只保存必要的数据。一旦数据不再有用，最好通过将其值设置为null来释放其引用 ---- 这个做法叫做 `解除引用`。
